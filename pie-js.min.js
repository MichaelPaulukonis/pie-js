"use strict";(function(t){"use strict";var i=t.pie=t.pie||{};i.defaultOptions={container:undefined,selectors:{sidebar:"#sidebar",layers:"#layers",panel:"#panel",canvas:"canvas"},callbacks:{onLoad:function n(){},onSave:function e(){},onError:function a(){},onClose:function s(){}},blocks:["layers","sidebar"],tabs:[],lang:"ru"};i.list=[];i.getEditorList=function(){return this.list};i.getEditor=function(t){return this.list[t]}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};i.Editor=function(t){this.id=Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,5);this.options=$.extend(true,i.defaultOptions,t);this.$elements={};this.layers=[];this.basics=new i.tabs.Basics(this,this.canvas);this.text=new i.tabs.Text(this,this.canvas);this.insertEditor();i.list[this.id]=this};i.Editor.prototype={insertEditor:function n(){var t=$(this.options.container||body),n=this.options.selectors||{};if(this.options.container!==undefined){var e=i.utils.template.render(this,"main.tpl",{});t=$(e).appendTo(this.options.container)}this.$elements={sidebar:t.find(this.options.container!==undefined?"#sidebar":n.sidebar),layers:t.find(this.options.container!==undefined?"#layers":n.layers),panel:t.find(this.options.container!==undefined?"#panel":n.panel),canvas:t.find(this.options.container!==undefined?"canvas":n.canvas)};this.canvas=new fabric.Canvas(this.$elements.canvas[0]);this.loadTabs();this.loadLayers();this.setEvents()},callTabFunction:function e(t,i,n){if(this.hasOwnProperty(t)&&this[t][i]!==undefined){return this[t][i].apply(this[t],n)}},loadTabs:function a(){var t=this;this.getConfig("tabs",function(n){var e=t.$elements.sidebar;for(var a in n){n[a]=t.callTabFunction(a,"loadTab",[n[a]])}var s=i.utils.template.render(t,"sidebar.tpl",{tabs:n});e.html(s).on("click","#navigation a",function(i){var n=$(this).data("target-tab");e.find("#navigation li").each(function(t,i){var n=$(i)});e.find("#tabs .tab").each(function(i,e){var a=$(e);if(a.attr("id")===n){t.callTabFunction(n,"activateTab",[a])}else{t.callTabFunction(n,"deactivateTab",[a])}a.toggle(a.attr("id")===n)})})})},getConfig:function s(t,i){$.ajax({url:"./config/"+t+".json",dataType:"json",success:function n(t){i(t)}})},setEvents:function o(){var t=this;this.canvas.on({"object:added":function i(){t.loadLayers()},"object:removed":function n(){t.loadLayers()}})},loadLayers:function r(){this.layers=[];var t=this.canvas.getObjects();for(var n in t){this.layers.push({name:t[n].cacheKey,object:t[n]})}var e=i.utils.template.render(this,"layers.tpl",{layers:this.layers});return this.$elements.layers.html(e)},getSelected:function c(){return this.canvas.getActiveObject()},getActiveStyle:function l(t,i){i=i||this.canvas.getActiveObject();if(!i)return"";return i.getSelectionStyles&&i.isEditing?i.getSelectionStyles()[t]||"":i[t]||""},setActiveStyle:function d(t,i,n){n=n||this.canvas.getActiveObject();if(!n)return;if(n.setSelectionStyles&&n.isEditing){var e={};e[t]=i;n.setSelectionStyles(e);n.setCoords()}else{n.set(t,i)}n.setCoords();this.canvas.renderAll()},getActiveProp:function u(t){var i=this.canvas.getActiveObject();if(!i)return"";return i[t]||""},setActiveProp:function f(t,i){var n=this.canvas.getActiveObject();if(!n)return;n.set(t,i).setCoords();this.canvas.renderAll()}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.tabs){i.tabs={}}if(i.tabs.Basics){console.warn("pie.tabs.basics is already defined.");return}i.tabs.Basics=function(t,i){this.editor=t;this.canvas=i;this.tab=undefined};i.tabs.Basics.prototype={loadTab:function n(t){return t},activateTab:function e(t,i){this.tab=t;return i},deactivateTab:function a(){},showBackgroundColor:function s(){var t=this,n=i.utils.panels.show(this.editor,"basics",{title:"Выбор цвета",type:"color"});i.utils.binding.bind(this.canvas,n,[this.canvas.renderAll.bind(this.canvas)],function(t,i,n){})},showBackgroundImage:function o(){},backgroundImage:function r(t){this.canvas.setBackgroundImage(t,this.canvas.renderAll.bind(this.canvas),{originX:"left",originY:"top"})},showResize:function c(){var t=this,n=i.utils.panels.show(this.editor,"basics",{title:"Resize",type:"resize",width:this.canvas.getWidth(),height:this.canvas.getHeight()});i.utils.binding.bind(t.canvas,n,function(){})},showRound:function l(){},rounded:function d(){},showAddImage:function u(){},addImage:function f(t){var i=this;fabric.Image.fromURL(t,function(t){i.canvas.add(t)})}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.tabs){i.tabs={}}if(i.tabs.Text){console.warn("pie.tabs.text is already defined.");return}i.tabs.Text=function(t,i){this.editor=t;this.canvas=i;this.tab=undefined};i.tabs.Text.prototype={loadTab:function n(t){return t},activateTab:function e(t,i){this.tab=t;this.loadFontList();this.tab.on("click","#fonts li",function(){});return i},deactivateTab:function a(){},loadFontList:function s(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var n=this;this.editor.getConfig("fonts",function(e){var a=[],s=[],o=[];for(var r in e){if(t!==""&&t!=="all"&&t!==r){continue}var c=e[r].items;s[r]=e[r].caption||r;a=a.concat(c);for(var l in c){if(c[l].font===""&&c[l].name!==""){o.push(c[l].name)}}}if(o.length>0){n.loadWebFont(o)}var d=i.utils.template.render(n,"tabs/text-fonts.tpl",{fonts:a});n.tab.find("#fonts").html(d)})},loadWebFont:function o(t){$("head").find('link[name="g-fonts"]').remove();$("head").append("<link href='http://fonts.googleapis.com/css?family="+t.join("|")+"' rel='stylesheet' type='text/css' name='g-fonts'>")},addText:function r(){var t="Lorem ipsum dolor sit amet,\nconsectetur adipisicing elit,\nsed do eiusmod tempor incididunt\nut labore et dolore magna aliqua.\n"+"Ut enim ad minim veniam,\nquis nostrud exercitation ullamco\nlaboris nisi ut aliquip ex ea commodo consequat.";var i=new fabric.Textbox(t.slice(0,getRandomInt(0,t.length)),{fontSize:20,left:getRandomInt(350,400),top:getRandomInt(350,400),fontFamily:"helvetica",angle:getRandomInt(-10,10),fill:"#"+getRandomColor(),fontWeight:"",originX:"left",width:300,hasRotatingPoint:true,centerTransform:true});this.canvas.add(i)}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.template){console.warn("pie.utils.template is already defined.");return}i.utils.template={render:function n(t,i,e){return nunjucks.render(i,$.extend(e,{id:t.id}))}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.panels){console.warn("pie.utils.panels is already defined.");return}i.utils.panels={selector:"#panel",element:undefined,setSelector:function n(){},show:function e(t,n,a){this.hide();var s=this,o=i.utils.template.render(t,"panels/"+n+".tpl",a);this.element=$(this.selector);return this.element.html(o).show().on("click",".panel-heading .close",function(){s.hide()})},hide:function a(){if(this.element===undefined){return}this.element.off().hide();i.utils.binding.unbind(this.element);delete this.element}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.tabs){console.warn("pie.utils.tabs is already defined.");return}i.utils.tabs={load:function n(t){var n=this;this.getConfig("tabs",function(e){var a=$(t||"#sidebar");for(var s in e){e[s]=n.callTabFunction(s,"loadTab",[e[s]])}var o=i.utils.template.render(n,"sidebar.tpl",{tabs:e});a.html(o).on("click","#navigation a",function(t){var i=$(this).data("target-tab");a.find("#navigation li").each(function(t,i){var n=$(i)});a.find("#tabs .tab").each(function(t,e){var a=$(e);if(a.attr("id")===i){n.callTabFunction(i,"activateTab",[a])}else{a.off();n.callTabFunction(i,"deactivateTab",[a])}a.toggle(a.attr("id")===i)})})})}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.binding){console.warn("pie.utils.binding is already defined.");return}i.utils.binding={bindings:[],checkTimer:undefined,bind:function n(t,i,e){var a=$(i),s=a.find("[data-prop-bind]");this.unbind(i);this._getValuesEvent(t,s,e);this._setValuesEvent(t,s,e)},_getValuesEvent:function e(t,i,n,a){var s=this;i.on("change",function(i){var e=$(i.target),o=e.attr("data-prop-bind"),r=e.val();var c="set"+o.charAt(0).toUpperCase()+o.substr(1);if(typeof t[c]==="function"){t[c].apply(t,[r].concat(n))}else if(t.hasOwnProperty(o)){t[o]=r}for(var l in s.bindings){var d=s.bindings[l];if(d.element!==i.target){continue}if(o===d.property&&r!==d.value){d.value=r;break}}if(typeof a==="function"){a(e,o,r)}})},_setValuesEvent:function a(t,i,n){var e=this;i.forEach(function(i){var n=$(i),a=n.attr("data-prop-bind")||"";if(a!==""){e.bindings.push({element:i,object:t,property:a,value:""})}});this.checkTimer=setInterval(function(){console.log("t");for(var t in e.bindings){var i=e.bindings[t],n=i.element,a=i.object,s=i.property,o=i.value,r="";var c="get"+s.charAt(0).toUpperCase()+s.substr(1);if(typeof a[c]==="function"){r=a[c]()}else if(a.hasOwnProperty(s)){r=a[s]}if(r!==o){i.value=r;$(n).val(r)}}},500)},unbind:function s(t){var i=this,n=$(t),e=n.find("[data-prop-bind]").length>0?n.find("[data-prop-bind]"):n;e.off("change");n.forEach(function(t){for(var n in i.bindings){if(i.bindings[n].element===t){debugger}}});clearInterval(this.checkTimer)}}})(window);