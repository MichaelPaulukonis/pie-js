"use strict";(function(t){"use strict";var i=t.pie=t.pie||{};i.defaultOptions={container:undefined,selectors:{sidebar:"#sidebar",layers:"#layers",panel:"#panel",canvas:"canvas"},callbacks:{onLoad:function e(){},onSave:function n(){},onError:function a(){},onClose:function s(){}},blocks:["layers","sidebar"],tabs:[],lang:"ru"};i.list=[];i.getEditorList=function(){return this.list};i.getEditor=function(t){return this.list[t]}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};i.Editor=function(t){this.id=Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,5);this.options=$.extend(true,i.defaultOptions,t);this.$elements={};this.layers=[];this.utils={tabs:new i.utils.Tabs(this),template:new i.utils.Template(this)};this._insertEditor();this.tabs={basics:new i.tabs.Basics(this),text:new i.tabs.Text(this),stickers:new i.tabs.Stickers(this)};i.list[this.id]=this};i.Editor.prototype={utils:{},tabs:{},_insertEditor:function e(){var t=$(this.options.container||body),i=this.options.selectors||{};if(this.options.container!==undefined){var e=this.utils.template.render("main.tpl",{});t=$(e).appendTo(this.options.container)}this.$elements={sidebar:t.find(this.options.container!==undefined?"#sidebar":i.sidebar),layers:t.find(this.options.container!==undefined?"#layers":i.layers),panel:t.find(this.options.container!==undefined?"#panel":i.panel),canvas:t.find(this.options.container!==undefined?"canvas":i.canvas)};this.canvas=new fabric.Canvas(this.$elements.canvas[0]);this.utils.tabs.load();this.loadLayers();this.setEvents()},_getConfig:function n(t,i){$.ajax({url:"./config/"+t+".json",dataType:"json",success:function e(t){i(t)}})},setEvents:function a(){var t=this;this.canvas.on({"object:added":function i(){t.loadLayers()},"object:removed":function e(){t.loadLayers()}});document.onkeydown=function(i){var e=5,n=t.canvas.getActiveGroup()||t.canvas.getActiveObject();if(n===undefined){return false}switch(i.keyCode){case 38:n.top-=e;break;case 40:n.top+=e;break;case 37:n.left-=e;break;case 39:n.left+=e;break;case 46:n.remove();break}if([37,38,39,40,46].indexOf(i.keyCode)>=0){i.preventDefault();t.canvas.renderAll()}}},loadLayers:function s(){this.layers=[];var t=this.canvas.getObjects();for(var i in t){this.layers.push({name:t[i].cacheKey,object:t[i]})}var e=this.utils.template.render("layers.tpl",{layers:this.layers});return this.$elements.layers.html(e)},getSelected:function o(){return this.activeObject},getActiveStyle:function r(t,i){i=i||this.activeObject;if(!i)return"";return i.getSelectionStyles&&i.isEditing?i.getSelectionStyles()[t]||"":i[t]||""},setActiveStyle:function c(t,i,e){e=e||this.activeObject;if(!e)return;if(e.setSelectionStyles&&e.isEditing){var n={};n[t]=i;e.setSelectionStyles(n);e.setCoords()}else{e.set(t,i)}e.setCoords();this.canvas.renderAll()},getActiveProp:function l(t){var i=this.activeObject;if(!i)return"";return i[t]||""},setActiveProp:function d(t,i){var e=this.activeObject;if(!e)return;e.set(t,i).setCoords();this.canvas.renderAll()}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.tabs){i.tabs={}}if(i.tabs.Basics){console.warn("pie.tabs.basics is already defined.");return}i.tabs.Basics=function(t){this.editor=t;this.canvas=t.canvas;this.tab=undefined};i.tabs.Basics.prototype={loadTab:function e(t){return t},activateTab:function n(t,i){this.tab=t;return i},deactivateTab:function a(){},showBackgroundColor:function s(){var t=this,e=i.utils.panels.show(this.editor,"basics",{title:"Выбор цвета",type:"color"});i.utils.binding.bind(this.canvas,e,[this.canvas.renderAll.bind(this.canvas)],function(t,i,e){})},showBackgroundImage:function o(){},backgroundImage:function r(t){this.canvas.setBackgroundImage(t,this.canvas.renderAll.bind(this.canvas),{originX:"left",originY:"top"})},showResize:function c(){var t=this,e=i.utils.panels.show(this.editor,"basics",{title:"Resize",type:"resize",width:this.canvas.getWidth(),height:this.canvas.getHeight()});i.utils.binding.bind(t.canvas,e,function(){})},showRound:function l(){},rounded:function d(){},showAddImage:function u(){},addImage:function f(t){var i=this;fabric.Image.fromURL(t,function(t){i.canvas.add(t)})}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.tabs){i.tabs={}}if(i.tabs.Text){console.warn("pie.tabs.text is already defined.");return}i.tabs.Text=function(t){this.editor=t;this.canvas=t.canvas;this.tab=undefined};i.tabs.Text.prototype={loadTab:function e(t){return t},activateTab:function n(t,i){this.tab=t;this.loadFontList();this.tab.on("click","#fonts li",function(){});return i},deactivateTab:function a(){},loadFontList:function s(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var i=this;this.editor._getConfig("fonts",function(e){var n=[],a={},s=[];for(var o in e){if(t!==""&&t!=="all"&&t!==o){continue}var r=e[o].items;a[o]=e[o].caption||o;for(var c in r){n.push({font:r[c].font,caption:r[c].caption,action:"addText",arguments:r[c].caption})}for(var c in r){if(r[c].font===""&&r[c].caption!==""){s.push(r[c].caption)}}}if(s.length>0){i.loadWebFont(s)}var l=i.editor.utils.template.render("tabs/text.tpl",{categories:a,fonts:n});i.tab.html(l)})},loadWebFont:function o(t){$("head").find('link[name="g-fonts"]').remove();$("head").append("<link href='http://fonts.googleapis.com/css?family="+t.join("|")+"' rel='stylesheet' type='text/css' name='g-fonts'>")},addText:function r(t){var i="Lorem ipsum dolor sit amet,\nconsectetur adipisicing elit,\nsed do eiusmod tempor incididunt\nut labore et dolore magna aliqua.\n"+"Ut enim ad minim veniam,\nquis nostrud exercitation ullamco\nlaboris nisi ut aliquip ex ea commodo consequat.";var e=new fabric.Textbox(i,{fontSize:20,left:Math.random(400),top:Math.random(400),fontFamily:t,angle:Math.random(10),fill:"#2196f3",fontWeight:"",originX:"left",width:300,hasRotatingPoint:true,centerTransform:true});this.canvas.add(e)}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.tabs){i.tabs={}}if(i.tabs.Stickers){console.warn("pie.tabs.stickers is already defined.");return}i.tabs.Stickers=function(t){this.editor=t;this.canvas=t.canvas;this.tab=undefined};i.tabs.Stickers.prototype={loadTab:function e(t){return t},activateTab:function n(t,i){this.tab=t;this._loadStickerList();this.tab.on("click","#fonts li",function(){});return i},deactivateTab:function a(){},_loadStickerList:function s(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var i=this;this.editor._getConfig("stickers",function(e){var n=[],a={};for(var s in e){if(t!==""&&t!=="all"&&t!==s){continue}var o=e[s].items;a[s]=e[s].caption||s;for(var r in o){n.push({caption:o[r].caption,image:"packs/stickers/"+s+"/"+o[r].image,action:"addImage",arguments:"./packs/stickers/"+s+"/"+o[r].image})}}var c=i.editor.utils.template.render("tabs/stickers.tpl",{categories:a,stickers:n});i.tab.html(c)})},addImage:function o(t){var i=this;fabric.Image.fromURL(t,function(t){i.canvas.add(t)})}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.Template){console.warn("pie.utils.template is already defined.");return}i.utils.Template=function(t){this.editor=t};i.utils.Template.prototype={render:function e(t,i){return nunjucks.render(t,$.extend(i,{id:this.editor.id}))}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.panels){console.warn("pie.utils.panels is already defined.");return}i.utils.panels={selector:"#panel",element:undefined,setSelector:function e(){},show:function n(t,i,e){this.hide();var n=this,a=t.utils.template.render("panels/"+i+".tpl",e);this.element=$(this.selector);return this.element.html(a).show().on("click",".panel-heading .close",function(){n.hide()})},hide:function a(){if(this.element===undefined){return}this.element.off().hide();i.utils.binding.unbind(this.element);delete this.element}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.Tabs){console.warn("pie.utils.tabs is already defined.");return}i.utils.Tabs=function(t){this.editor=t};i.utils.Tabs.prototype={load:function e(){var t=this;this.editor._getConfig("tabs",function(i){var e={};for(var n in i){e[n]=t._callFunction(n,"loadTab",[i[n]])}var a=t.editor.utils.template.render("sidebar.tpl",{tabs:e});var s=t.editor.$elements.sidebar;s.html(a).on("click","#navigation a[pie-target-tab]",function(i){t._onTabClick(this,i)});s.find("#tabs").on("click",".tab a[pie-action]",function(i){t._onTabItemClick(this,i)})})},_onTabClick:function n(t,i){var e=this,n=this.editor.$elements.sidebar;var a=$(t).attr("pie-target-tab");n.find("#navigation a[pie-target-tab]").each(function(t,i){var e=$(i)});n.find("#tabs .tab").each(function(t,i){var n=$(i);if(n.attr("pie-tab")===a){e._callFunction(a,"activateTab",[n])}else{n.off();e._callFunction(a,"deactivateTab",[n])}n.toggle(n.attr("pie-tab")===a)})},_onTabItemClick:function a(t,i){var e=$(t).parents(".tab").attr("pie-tab"),n=$(t).attr("pie-action"),a=$(t).attr("pie-arguments");this._callFunction(e,n,[].concat(a))},_callFunction:function s(t,i,e){if(this.editor.tabs.hasOwnProperty(t)&&this.editor.tabs[t][i]!==undefined){return this.editor.tabs[t][i].apply(this.editor.tabs[t],e)}}}})(window);(function(t){"use strict";var i=t.pie=t.pie||{};if(!i.utils){i.utils={}}if(i.utils.binding){console.warn("pie.utils.binding is already defined.");return}i.utils.binding={bindings:[],checkTimer:undefined,bind:function e(t,i,n){var a=$(i),s=a.find("[data-prop-bind]");this.unbind(i);this._getValuesEvent(t,s,n);this._setValuesEvent(t,s,n)},_getValuesEvent:function n(t,i,e,a){var s=this;i.on("change",function(i){var n=$(i.target),o=n.attr("data-prop-bind"),r=n.val();var c="set"+o.charAt(0).toUpperCase()+o.substr(1);if(typeof t[c]==="function"){t[c].apply(t,[r].concat(e))}else if(t.hasOwnProperty(o)){t[o]=r}for(var l in s.bindings){var d=s.bindings[l];if(d.element!==i.target){continue}if(o===d.property&&r!==d.value){d.value=r;break}}if(typeof a==="function"){a(n,o,r)}})},_setValuesEvent:function a(t,i,e){var n=this;i.forEach(function(i){var e=$(i),a=e.attr("data-prop-bind")||"";if(a!==""){n.bindings.push({element:i,object:t,property:a,value:""})}});this.checkTimer=setInterval(function(){console.log("t");for(var t in n.bindings){var i=n.bindings[t],e=i.element,a=i.object,s=i.property,o=i.value,r="";var c="get"+s.charAt(0).toUpperCase()+s.substr(1);if(typeof a[c]==="function"){r=a[c]()}else if(a.hasOwnProperty(s)){r=a[s]}if(r!==o){i.value=r;$(e).val(r)}}},500)},unbind:function s(t){var i=this,e=$(t),n=e.find("[data-prop-bind]").length>0?e.find("[data-prop-bind]"):e;n.off("change");e.forEach(function(t){for(var e in i.bindings){if(i.bindings[e].element===t){debugger}}});clearInterval(this.checkTimer)}}})(window);